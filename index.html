import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, where } from 'firebase/firestore';

// Lucide React icons for a professional look
import { 
    Home, User, MapPin, Calendar, UsersQ, Settings, Plus, Edit, Trash2, LogIn, LogOut, CheckCheck
} from 'lucide-react';

// Main App component
export default function App() {
    // --- State Management ---
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [userName, setUserName] = useState('');
    const [isAdmin, setIsAdmin] = useState(false);
    const [userLocation, setUserLocation] = useState(null);
    const [distance, setDistance] = useState(null);
    const [isInsideOffice, setIsInsideOffice] = useState(false);
    const [isCheckingIn, setIsCheckingIn] = useState(false);
    const [isCheckingOut, setIsCheckingOut] = useState(false);
    const [attendanceRecord, setAttendanceRecord] = useState(null);
    const [allAttendance, setAllAttendance] = useState([]);
    const [statusMessage, setStatusMessage] = useState('Initializing app...');
    const [filterDate, setFilterDate] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM format
    const [monthlyReport, setMonthlyReport] = useState({});
    const [loginScreenUserId, setLoginScreenUserId] = useState('');
    const [currentView, setCurrentView] = useState('dashboard');
    
    // New state for attendance history page
    const [currentAttendanceDate, setCurrentAttendanceDate] = useState(new Date().toISOString().slice(0, 10)); // YYYY-MM-DD format
    const [dailyAttendanceRecord, setDailyAttendanceRecord] = useState(null);

    // Office settings state
    const [targetLocation, setTargetLocation] = useState({ latitude: 37.7749, longitude: -122.4194 });
    const [validRadius, setValidRadius] = useState(200); // in meters
    const [adminLatitude, setAdminLatitude] = useState('');
    const [adminLongitude, setAdminLongitude] = useState('');
    const [adminRadius, setAdminRadius] = useState(200);

    // Employee management state
    const [newEmployeeName, setNewEmployeeName] = useState('');
    const [newEmployeeId, setNewEmployeeId] = useState('');
    const [allEmployees, setAllEmployees] = useState([]);
    const [selectedEmployeeId, setSelectedEmployeeId] = useState(null);
    const [selectedEmployeeName, setSelectedEmployeeName] = useState('');

    // Modal states for admin
    const [isManualEntryModalOpen, setIsManualEntryModalOpen] = useState(false);
    const [editingRecord, setEditingRecord] = useState(null);
    const [editedCheckIn, setEditedCheckIn] = useState('');
    const [editedCheckOut, setEditedCheckOut] = useState('');
    const [manualEntryDate, setManualEntryDate] = useState('');
    const [confirmingDeleteId, setConfirmingDeleteId] = useState(null);

    // --- Configuration ---
    // Admin user ID.
    const ADMIN_USER_ID = 'your_admin_user_id_here';

    // --- Firebase Initialization and Auth ---
    useEffect(() => {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig;

        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);
            setAuth(authInstance);
            setDb(dbInstance);

            const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (customToken) {
                signInWithCustomToken(authInstance, customToken).catch(e => {
                    console.error("Custom token sign-in failed: ", e);
                    setStatusMessage('Custom token sign-in failed. Check console for details.');
                });
            } else {
                signInAnonymously(authInstance).catch(e => {
                    console.error("Anonymous sign-in failed: ", e);
                    setStatusMessage('Anonymous sign-in failed. Check console for details.');
                });
            }
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            setStatusMessage('Error: Firebase initialization failed. Check console for details.');
        }
    }, []);

    useEffect(() => {
        if (!auth) return;
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (user) {
                setLoginScreenUserId(user.uid);
            }
        });
        return () => unsubscribe();
    }, [auth]);

    // --- Geolocation Logic ---
    useEffect(() => {
        if (!userId) return;

        const updateLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        setUserLocation({ latitude, longitude });
                        const dist = calculateDistance(latitude, longitude, targetLocation.latitude, targetLocation.longitude);
                        setDistance(dist);
                        setIsInsideOffice(dist <= validRadius);
                        setStatusMessage(
                            dist <= validRadius
                                ? 'You are inside the office location.'
                                : `You are ${dist.toFixed(0)} meters away from the office.`
                        );
                    },
                    (error) => {
                        console.error("Geolocation error:", error.message || error);
                        let errorMessage = 'An unknown error occurred while fetching your location.';
                        if (error && error.code) {
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMessage = 'Location access denied. Please enable location services in your browser settings.';
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errorMessage = 'Location information is unavailable.';
                            } else if (error.code === error.TIMEOUT) {
                                errorMessage = 'The request to get user location timed out.';
                            }
                        } else if (error && error.message) {
                            if (error.message.includes('permissions policy')) {
                                errorMessage = 'Geolocation has been disabled in this document by permissions policy. Please enable it or try a different browser.';
                            } else {
                                errorMessage = `Geolocation error: ${error.message}`;
                            }
                        }
                        setStatusMessage(`Error: ${errorMessage}`);
                        setIsInsideOffice(false);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                setStatusMessage('Error: Geolocation is not supported by your browser.');
                setIsInsideOffice(false);
            }
        };

        updateLocation();
        const intervalId = setInterval(updateLocation, 5000);
        return () => clearInterval(intervalId);
    }, [userId, targetLocation, validRadius]);

    // --- Firestore Data Logic ---
    // Load office settings and listen for changes
    useEffect(() => {
        if (!db) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const settingsDocRef = doc(db, 'artifacts', appId, 'office-settings', 'main');

        const unsubscribe = onSnapshot(settingsDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const settings = docSnap.data();
                setTargetLocation({
                    latitude: settings.latitude,
                    longitude: settings.longitude
                });
                setValidRadius(settings.radius || 200);
                setAdminLatitude(settings.latitude);
                setAdminLongitude(settings.longitude);
                setAdminRadius(settings.radius || 200);
            } else {
                setAdminLatitude(targetLocation.latitude);
                setAdminLongitude(targetLocation.longitude);
                setAdminRadius(validRadius);
                setStatusMessage('Using default office location settings.');
            }
        }, (error) => {
            console.error("Error fetching office settings:", error);
            setStatusMessage('Error: Failed to fetch office settings. Please check Firebase security rules.');
        });
        return () => unsubscribe();
    }, [db]);

    // Load attendance data and employees
    useEffect(() => {
        if (!db || !userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (isAdmin) {
            if (!filterDate) return;
            const [year, month] = filterDate.split('-');
            const firstDayOfMonth = new Date(year, month - 1, 1).toISOString().slice(0, 10);
            const lastDayOfMonth = new Date(year, month, 0).toISOString().slice(0, 10);

            const q = query(collection(db, 'artifacts', appId, 'attendance'), where('date', '>=', firstDayOfMonth), where('date', '<=', lastDayOfMonth));
            
            const unsubscribeAttendance = onSnapshot(q, (querySnapshot) => {
                const records = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAllAttendance(records);
            }, (error) => {
                console.error("Error fetching admin attendance data:", error);
                setStatusMessage('Error fetching admin data.');
            });
            
            const employeesRef = collection(db, 'artifacts', appId, 'users');
            const unsubscribeEmployees = onSnapshot(employeesRef, (querySnapshot) => {
                const employees = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAllEmployees(employees);
            }, (error) => {
                console.error("Error fetching employee data:", error);
                setStatusMessage('Error fetching employee data.');
            });

            return () => {
                unsubscribeAttendance();
                unsubscribeEmployees();
            };
        } else {
            const today = new Date().toISOString().slice(0, 10);
            const userAttendanceDocRef = doc(db, 'artifacts', appId, 'users', userId, 'attendance', today);
            const unsubscribe = onSnapshot(userAttendanceDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    setAttendanceRecord({ id: docSnap.id, ...docSnap.data() });
                } else {
                    setAttendanceRecord(null);
                }
            }, (error) => {
                console.error("Error fetching user attendance data:", error);
                setStatusMessage('Error fetching your attendance data.');
            });
            return () => unsubscribe();
        }
    }, [db, userId, isAdmin, filterDate]);
    
    // Fetch daily attendance for the history page
    useEffect(() => {
        if (!db || !userId || isAdmin) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userAttendanceDocRef = doc(db, 'artifacts', appId, 'users', userId, 'attendance', currentAttendanceDate);
        
        const unsubscribe = onSnapshot(userAttendanceDocRef, (docSnap) => {
            if (docSnap.exists()) {
                setDailyAttendanceRecord({ id: docSnap.id, ...docSnap.data() });
            } else {
                setDailyAttendanceRecord(null);
            }
        }, (error) => {
            console.error("Error fetching daily attendance data:", error);
            setStatusMessage('Error fetching daily attendance.');
        });
        
        return () => unsubscribe();
    }, [db, userId, isAdmin, currentAttendanceDate]);

    // Generate Monthly Report
    useEffect(() => {
        if (isAdmin && allAttendance.length > 0) {
            const report = {};
            allAttendance.forEach(record => {
                if (!report[record.userId]) {
                    const employee = allEmployees.find(emp => emp.id === record.userId);
                    report[record.userId] = {
                        userId: record.userId,
                        userName: employee ? employee.name : record.userId,
                        totalDays: 0,
                        detailedRecords: []
                    };
                }
                report[record.userId].totalDays++;
                report[record.userId].detailedRecords.push(record);
            });
            setMonthlyReport(report);
        } else {
            setMonthlyReport({});
        }
    }, [isAdmin, allAttendance, allEmployees]);

    // --- Actions ---
    const handleLogin = async () => {
        if (!loginScreenUserId) {
            setStatusMessage('Please enter a User ID to log in.');
            return;
        }

        const loggedInUserId = loginScreenUserId.trim();
        setUserId(loggedInUserId);
        setIsAdmin(loggedInUserId === ADMIN_USER_ID);
        setStatusMessage(`Login successful for: ${loggedInUserId}`);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userDocRef = doc(db, 'artifacts', appId, 'users', loggedInUserId);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists()) {
            setUserName(userDocSnap.data().name || loggedInUserId);
        } else {
            const newUserName = `Employee_${loggedInUserId.substring(0, 4)}`;
            await setDoc(userDocRef, { name: newUserName });
            setUserName(newUserName);
        }
    };
    
    const handleCheckIn = async () => {
        if (!userId || !isInsideOffice) return;
        setIsCheckingIn(true);
        const today = new Date().toISOString().slice(0, 10);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userAttendanceDocRef = doc(db, 'artifacts', appId, 'users', userId, 'attendance', today);

        try {
            await setDoc(userAttendanceDocRef, {
                checkIn: serverTimestamp(),
                userId,
                userName,
                date: today,
            });
            const publicDocRef = doc(db, 'artifacts', appId, 'attendance', today + '-' + userId);
            await setDoc(publicDocRef, {
                checkIn: serverTimestamp(),
                userId,
                userName,
                date: today
            });
            setStatusMessage('Check-in successful!');
        } catch (e) {
            console.error("Error checking in: ", e);
            setStatusMessage('Error: Check-in failed. Please try again.');
        } finally {
            setIsCheckingIn(false);
        }
    };

    const handleCheckOut = async () => {
        if (!userId || !isInsideOffice || !attendanceRecord) return;
        setIsCheckingOut(true);
        const today = new Date().toISOString().slice(0, 10);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userAttendanceDocRef = doc(db, 'artifacts', appId, 'users', userId, 'attendance', today);

        try {
            await setDoc(userAttendanceDocRef, { checkOut: serverTimestamp() }, { merge: true });
            const publicDocRef = doc(db, 'artifacts', appId, 'attendance', today + '-' + userId);
            await setDoc(publicDocRef, { checkOut: serverTimestamp() }, { merge: true });
            setStatusMessage('Check-out successful!');
        } catch (e) {
            console.error("Error checking out: ", e);
            setStatusMessage('Error: Check-out failed. Please try again.');
        } finally {
            setIsCheckingOut(false);
        }
    };

    // --- Admin Actions ---
    const handleSaveLocation = async () => {
        if (!db) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const settingsDocRef = doc(db, 'artifacts', appId, 'office-settings', 'main');
        try {
            await setDoc(settingsDocRef, {
                latitude: Number(adminLatitude),
                longitude: Number(adminLongitude),
                radius: Number(adminRadius)
            });
            setStatusMessage('Office location and radius successfully updated!');
            setTargetLocation({
                latitude: Number(adminLatitude),
                longitude: Number(adminLongitude)
            });
            setValidRadius(Number(adminRadius));
        } catch (e) {
            console.error("Error saving location:", e);
            setStatusMessage('Error: Failed to save location.');
        }
    };

    const handleAddEmployee = async () => {
        if (!newEmployeeName || !newEmployeeId) {
            setStatusMessage('Both employee name and User ID are required.');
            return;
        }

        const employeeId = newEmployeeId.trim();
        const employeeName = newEmployeeName.trim();
        if (employeeId === ADMIN_USER_ID) {
            setStatusMessage('This User ID is reserved for Admin.');
            return;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userDocRef = doc(db, 'artifacts', appId, 'users', employeeId);

        try {
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                setStatusMessage('This User ID already exists.');
                return;
            }

            await setDoc(userDocRef, { name: employeeName });
            setStatusMessage(`New employee ${employeeName} (${employeeId}) has been added!`);
            setNewEmployeeName('');
            setNewEmployeeId('');
        } catch (e) {
            console.error("Error adding employee:", e);
            setStatusMessage('Error: Failed to add employee.');
        }
    };
    
    // Admin: Save or update attendance record
    const handleSaveManualEntry = async () => {
        if (!db || (!editingRecord && !manualEntryDate)) {
            setStatusMessage('Date and Employee ID are required.');
            return;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userIdToUpdate = editingRecord ? editingRecord.userId : selectedEmployeeId;
        const userNameToUpdate = editingRecord ? editingRecord.userName : selectedEmployeeName;
        const dateToUpdate = editingRecord ? editingRecord.date : manualEntryDate;

        try {
            const checkInTime = editedCheckIn ? new Date(`${dateToUpdate}T${editedCheckIn}`) : null;
            const checkOutTime = editedCheckOut ? new Date(`${dateToUpdate}T${editedCheckOut}`) : null;
            
            const privateDocRef = doc(db, 'artifacts', appId, 'users', userIdToUpdate, 'attendance', dateToUpdate);
            const publicDocRef = doc(db, 'artifacts', appId, 'attendance', dateToUpdate + '-' + userIdToUpdate);
            
            await setDoc(privateDocRef, {
                checkIn: checkInTime ? serverTimestamp() : null,
                checkOut: checkOutTime ? serverTimestamp() : null,
                userId: userIdToUpdate,
                userName: userNameToUpdate,
                date: dateToUpdate,
            }, { merge: true });

            await setDoc(publicDocRef, {
                checkIn: checkInTime ? serverTimestamp() : null,
                checkOut: checkOutTime ? serverTimestamp() : null,
                userId: userIdToUpdate,
                userName: userNameToUpdate,
                date: dateToUpdate,
            }, { merge: true });

            setStatusMessage(editingRecord ? 'Attendance record successfully updated!' : 'New attendance record added successfully!');
            setIsManualEntryModalOpen(false);
            setEditingRecord(null);
        } catch (e) {
            console.error("Error saving manual entry:", e);
            setStatusMessage('Error: Failed to save manual record.');
        }
    };
    
    // Admin: Delete attendance record
    const handleDeleteRecord = async () => {
        if (!db || !confirmingDeleteId) return;

        const recordToDelete = allAttendance.find(r => r.id === confirmingDeleteId);
        if (!recordToDelete) return;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        try {
            const privateDocRef = doc(db, 'artifacts', appId, 'users', recordToDelete.userId, 'attendance', recordToDelete.date);
            await deleteDoc(privateDocRef);

            const publicDocRef = doc(db, 'artifacts', appId, 'attendance', recordToDelete.date + '-' + recordToDelete.userId);
            await deleteDoc(publicDocRef);
            
            setStatusMessage('Attendance record successfully deleted!');
        } catch (e) {
            console.error("Error deleting record:", e);
            setStatusMessage('Error: Failed to delete record.');
        } finally {
            setConfirmingDeleteId(null);
        }
    };
    
    // --- Utility Functions ---
    const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI / 180;
        const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    };
    
    const formatTimestamp = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate();
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    };

    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp.toDate();
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
    };
    
    const formatISODate = (isoDate) => {
        if (!isoDate) return 'N/A';
        const date = new Date(isoDate);
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    const calculateWorkingHours = (record) => {
        if (!record.checkIn || !record.checkOut) {
            return 'N/A';
        }
        const checkInTime = record.checkIn.toDate();
        const checkOutTime = record.checkOut.toDate();
        const diffInMs = checkOutTime.getTime() - checkInTime.getTime();
        const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
        const hours = Math.floor(diffInMinutes / 60);
        const minutes = diffInMinutes % 60;
        return `${hours}h ${minutes}m`;
    };
    
    const getDaysInMonth = (year, month) => {
        const date = new Date(year, month, 1);
        const days = [];
        while (date.getMonth() === month) {
            days.push(new Date(date).toISOString().slice(0, 10));
            date.setDate(date.getDate() + 1);
        }
        return days;
    };
    
    const startManualEntry = (record) => {
        if (record) {
            setEditingRecord(record);
            setEditedCheckIn(record.checkIn ? record.checkIn.toDate().toTimeString().slice(0, 5) : '');
            setEditedCheckOut(record.checkOut ? record.checkOut.toDate().toTimeString().slice(0, 5) : '');
            setIsManualEntryModalOpen(true);
        } else {
            setEditingRecord(null);
            setEditedCheckIn('');
            setEditedCheckOut('');
            setIsManualEntryModalOpen(true);
        }
    };

    // --- UI Components ---
    // LoginPage component
    const LoginPage = () => (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm space-y-8">
                <div className="flex flex-col items-center space-y-2">
                    <CheckCheck size={48} className="text-blue-600" />
                    <h1 className="text-3xl font-extrabold text-gray-900">Attendance App</h1>
                    <p className="text-sm text-gray-500">Please log in</p>
                </div>
                <div className="space-y-4">
                    <input
                        type="text"
                        value={loginScreenUserId}
                        onChange={(e) => setLoginScreenUserId(e.target.value)}
                        placeholder="Enter User ID (e.g., employee_123)"
                        className="w-full p-4 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    />
                    <button
                        onClick={handleLogin}
                        className="w-full py-4 px-6 rounded-xl font-bold text-lg text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        <LogIn className="inline mr-2" size={20} />
                        Log In
                    </button>
                </div>
                <div className="text-center text-sm text-gray-500 min-h-[20px]">
                    {statusMessage}
                </div>
            </div>
        </div>
    );

    // EmployeeDashboard component
    const EmployeeDashboard = () => (
        <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg space-y-6">
            <h1 className="text-2xl font-bold text-center text-gray-800">Hello, {userName}!</h1>
            <p className="text-sm text-center text-gray-600">Your User ID: {userId}</p>

            <div className={`p-4 rounded-xl text-center font-semibold ${isInsideOffice ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                {statusMessage}
            </div>

            <div className="flex space-x-4">
                <button
                    onClick={handleCheckIn}
                    disabled={!isInsideOffice || attendanceRecord?.checkIn || isCheckingIn}
                    className="flex-1 flex items-center justify-center py-3 px-6 rounded-xl font-bold text-lg text-white bg-green-500 hover:bg-green-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <CheckCheck className="inline mr-2" size={20} />
                    {isCheckingIn ? 'Checking In...' : 'Check In'}
                </button>
                <button
                    onClick={handleCheckOut}
                    disabled={!isInsideOffice || !attendanceRecord?.checkIn || attendanceRecord?.checkOut || isCheckingOut}
                    className="flex-1 flex items-center justify-center py-3 px-6 rounded-xl font-bold text-lg text-white bg-red-500 hover:bg-red-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <LogOut className="inline mr-2" size={20} />
                    {isCheckingOut ? 'Checking Out...' : 'Check Out'}
                </button>
            </div>
            
            <button
                onClick={() => setCurrentView('attendanceHistory')}
                className="w-full py-3 px-6 rounded-xl font-bold text-lg text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300">
                <Calendar className="inline mr-2" size={20} />
                View Attendance History
            </button>

            <div className="border-t pt-6 mt-6 border-gray-200">
                <h2 className="text-xl font-semibold text-gray-700 mb-4">Today's Attendance</h2>
                <ul className="space-y-3">
                    {attendanceRecord ? (
                        <li className="bg-gray-50 p-4 rounded-xl flex justify-between items-center shadow-sm">
                            <div>
                                <span className="text-gray-800 font-medium block">{formatDate(attendanceRecord.checkIn)}</span>
                            </div>
                            <div className="text-right">
                                <div className="text-green-600 font-semibold text-sm">Check-in: {formatTimestamp(attendanceRecord.checkIn)}</div>
                                <div className="text-red-600 font-semibold text-sm mt-1">Check-out: {formatTimestamp(attendanceRecord.checkOut)}</div>
                            </div>
                        </li>
                    ) : (
                        <li className="text-center text-gray-500 italic">No attendance record for today.</li>
                    )}
                </ul>
            </div>
        </div>
    );
    
    // AttendanceHistoryPage component
    const AttendanceHistoryPage = () => (
        <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg space-y-6">
            <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold text-gray-800">Attendance History</h1>
                <button
                    onClick={() => setCurrentView('dashboard')}
                    className="text-sm font-medium text-blue-600 hover:underline">
                    <Home className="inline mr-1" size={16} />
                    Back to Dashboard
                </button>
            </div>

            <div className="mt-4">
                <label htmlFor="date-select" className="block text-gray-700 font-medium mb-2">Select Date:</label>
                <input
                    type="date"
                    id="date-select"
                    value={currentAttendanceDate}
                    onChange={(e) => setCurrentAttendanceDate(e.target.value)}
                    className="w-full p-2 rounded-xl border border-gray-300 text-gray-700 focus:ring-2 focus:ring-blue-500"
                />
            </div>
            
            <div className="border-t pt-6 mt-6 border-gray-200">
                <h2 className="text-xl font-semibold text-gray-700 mb-4">Record for {formatISODate(currentAttendanceDate)}</h2>
                {dailyAttendanceRecord ? (
                    <div className="bg-gray-50 p-4 rounded-xl flex justify-between items-center shadow-sm">
                        <div className="text-right">
                            <div className="text-green-600 font-semibold text-sm">Check-in: {formatTimestamp(dailyAttendanceRecord.checkIn)}</div>
                            <div className="text-red-600 font-semibold text-sm mt-1">Check-out: {formatTimestamp(dailyAttendanceRecord.checkOut)}</div>
                        </div>
                    </div>
                ) : (
                    <p className="text-center text-gray-500 italic">No attendance record found for this date.</p>
                )}
            </div>
        </div>
    );

    // AdminDashboardMain component
    const AdminDashboardMain = () => (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-gray-800">Monthly Report</h2>
            <div className="mt-4 flex items-center space-x-4">
                <label htmlFor="month-select" className="text-gray-700 font-medium">Select Month:</label>
                <input
                    type="month"
                    id="month-select"
                    value={filterDate}
                    onChange={(e) => {
                        setFilterDate(e.target.value);
                    }}
                    className="flex-1 rounded-xl border border-gray-300 p-2 text-gray-700 focus:ring-2 focus:ring-blue-500"
                />
            </div>
            <ul className="space-y-4">
                {Object.keys(monthlyReport).length === 0 ? (
                    <li className="text-center text-gray-500 italic">No attendance records found for this month.</li>
                ) : (
                    Object.keys(monthlyReport).map(key => (
                        <li key={key} 
                            className="bg-gray-50 p-4 rounded-xl shadow-md cursor-pointer hover:bg-gray-100 transition-colors duration-150"
                            onClick={() => {
                                setCurrentView('monthlyReport');
                                setSelectedEmployeeId(key);
                                const employee = allEmployees.find(emp => emp.id === key);
                                setSelectedEmployeeName(employee ? employee.name : key);
                            }}>
                            <div className="flex justify-between items-start">
                                <div className="flex-1">
                                    <p className="font-semibold text-gray-800">
                                        <User className="inline mr-2" size={16} />
                                        {monthlyReport[key].userName}
                                    </p>
                                    <p className="text-sm text-gray-600 ml-6">User ID: {monthlyReport[key].userId}</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-green-600 font-semibold text-sm">Total Days: {monthlyReport[key].totalDays}</p>
                                </div>
                            </div>
                        </li>
                    ))
                )}
            </ul>
        </div>
    );

    // OfficeSettings component
    const OfficeSettings = () => (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Set Office Location & Radius</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex flex-col">
                    <label htmlFor="lat" className="text-sm font-medium text-gray-700">Latitude</label>
                    <input
                        id="lat"
                        type="number"
                        step="any"
                        value={adminLatitude}
                        onChange={(e) => setAdminLatitude(e.target.value)}
                        className="mt-1 p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="lon" className="text-sm font-medium text-gray-700">Longitude</label>
                    <input
                        id="lon"
                        type="number"
                        step="any"
                        value={adminLongitude}
                        onChange={(e) => setAdminLongitude(e.target.value)}
                        className="mt-1 p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
            </div>
            <div className="flex flex-col mt-4">
                <label htmlFor="radius" className="text-sm font-medium text-gray-700">Valid Radius (in meters)</label>
                <input
                    id="radius"
                    type="number"
                    value={adminRadius}
                    onChange={(e) => setAdminRadius(e.target.value)}
                    className="mt-1 p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
            </div>
            <button
                onClick={handleSaveLocation}
                className="mt-4 w-full py-3 px-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300">
                <Settings className="inline mr-2" size={20} />
                Save Location & Radius
            </button>
        </div>
    );

    // AdminMonthlyReport component
    const AdminMonthlyReport = () => {
        const [year, month] = filterDate.split('-');
        const allDaysInMonth = getDaysInMonth(Number(year), Number(month) - 1);
        const employeeRecords = monthlyReport[selectedEmployeeId]?.detailedRecords || [];
        
        const recordsByDay = allDaysInMonth.map(day => {
            const record = employeeRecords.find(r => r.date === day);
            return record || { date: day, isAbsent: true, id: `${day}-${selectedEmployeeId}` };
        });

        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-gray-800">Report: {selectedEmployeeName}</h2>
                    <button
                        onClick={() => {
                            setCurrentView('dashboard');
                            setSelectedEmployeeId(null);
                        }}
                        className="text-sm font-medium text-blue-600 hover:underline">
                        <Calendar className="inline mr-1" size={16} />
                        Back to Monthly Report
                    </button>
                </div>
                <div className="space-y-3">
                    {recordsByDay.length > 0 ? (
                        recordsByDay.map(record => (
                            <div key={record.id} className="bg-gray-50 p-4 rounded-xl flex justify-between items-center shadow-sm">
                                <span className="text-gray-800 font-medium">{formatISODate(record.date)}</span>
                                <div className="text-right flex items-center space-x-4">
                                    {record.isAbsent ? (
                                        <span className="text-red-500 font-semibold text-sm">Absent</span>
                                    ) : (
                                        <div>
                                            <div className="text-green-600 font-semibold text-sm">Check-in: {formatTimestamp(record.checkIn)}</div>
                                            <div className="text-red-600 font-semibold text-sm mt-1">Check-out: {formatTimestamp(record.checkOut)}</div>
                                            <div className="text-gray-600 font-medium text-sm mt-1">Working Hours: {calculateWorkingHours(record)}</div>
                                        </div>
                                    )}
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => {
                                                setManualEntryDate(record.date);
                                                startManualEntry(record.isAbsent ? null : record);
                                            }}
                                            className="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors duration-150">
                                            {record.isAbsent ? <Plus size={16} /> : <Edit size={16} />}
                                        </button>
                                        {!record.isAbsent && (
                                            <button
                                                onClick={() => setConfirmingDeleteId(record.id)}
                                                className="text-sm font-medium text-red-600 hover:text-red-800 transition-colors duration-150">
                                                <Trash2 size={16} />
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center text-gray-500 italic">No records found for this employee this month.</div>
                    )}
                </div>
            </div>
        );
    };

    // EmployeeManagement component
    const EmployeeManagement = () => (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Manage Employees</h2>
            <div className="bg-gray-100 p-6 rounded-2xl shadow-inner space-y-4">
                <h3 className="text-lg font-semibold text-gray-700">Add New Employee</h3>
                <div className="flex flex-col">
                    <label htmlFor="employee-name" className="text-sm font-medium text-gray-700">Employee Name</label>
                    <input
                        id="employee-name"
                        type="text"
                        value={newEmployeeName}
                        onChange={(e) => setNewEmployeeName(e.target.value)}
                        placeholder="Name"
                        className="mt-1 p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="employee-id" className="text-sm font-medium text-gray-700">Unique User ID</label>
                    <input
                        id="employee-id"
                        type="text"
                        value={newEmployeeId}
                        onChange={(e) => setNewEmployeeId(e.target.value)}
                        placeholder="e.g., employee_id_123"
                        className="mt-1 p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <button
                    onClick={handleAddEmployee}
                    className="w-full py-3 px-4 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 transition-colors duration-200">
                    <Plus className="inline mr-2" size={20} />
                    Add Employee
                </button>
            </div>
            
            <h3 className="text-lg font-semibold text-gray-700 mt-6">Existing Employees (Total: {allEmployees.length})</h3>
            <ul className="space-y-2">
                {allEmployees.map(employee => (
                    <li key={employee.id} className="bg-gray-50 p-4 rounded-xl shadow-sm flex items-center space-x-3">
                        <User size={20} className="text-gray-500" />
                        <div>
                            <p className="font-medium text-gray-800">{employee.name}</p>
                            <p className="text-sm text-gray-600">User ID: {employee.id}</p>
                        </div>
                    </li>
                ))}
            </ul>
        </div>
    );
    
    // Manual Entry/Edit Modal
    const ManualEntryModal = () => (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md space-y-6">
                <h3 className="text-xl font-bold text-gray-800">{editingRecord ? 'Edit Attendance Record' : 'Add Manual Attendance'}</h3>
                <p className="text-sm text-gray-600">
                    Employee: <span className="font-semibold">{selectedEmployeeName}</span>
                </p>
                <div className="flex flex-col space-y-3">
                    <label className="block text-sm font-medium text-gray-700">Date</label>
                    <input
                        type="date"
                        value={editingRecord?.date || manualEntryDate}
                        onChange={(e) => setManualEntryDate(e.target.value)}
                        disabled={!!editingRecord}
                        className="mt-1 block w-full rounded-xl border border-gray-300 shadow-sm p-3 focus:ring-2 focus:ring-blue-500"
                    />
                    <label className="block text-sm font-medium text-gray-700">Check-in Time</label>
                    <input
                        type="time"
                        value={editedCheckIn}
                        onChange={(e) => setEditedCheckIn(e.target.value)}
                        className="mt-1 block w-full rounded-xl border border-gray-300 shadow-sm p-3 focus:ring-2 focus:ring-blue-500"
                    />
                    <label className="block text-sm font-medium text-gray-700">Check-out Time</label>
                    <input
                        type="time"
                        value={editedCheckOut}
                        onChange={(e) => setEditedCheckOut(e.target.value)}
                        className="mt-1 block w-full rounded-xl border border-gray-300 shadow-sm p-3 focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <div className="flex justify-end space-x-2">
                    <button
                        onClick={() => { setIsManualEntryModalOpen(false); setEditingRecord(null); }}
                        className="py-3 px-5 border border-gray-300 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        Cancel
                    </button>
                    <button
                        onClick={handleSaveManualEntry}
                        className="py-3 px-5 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700 transition-colors">
                        Save
                    </button>
                </div>
            </div>
        </div>
    );

    // Delete Confirmation Modal
    const DeleteConfirmationModal = () => (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md space-y-6 text-center">
                <h3 className="text-xl font-bold text-gray-800">Delete Record?</h3>
                <p className="text-sm text-gray-600">Are you sure you want to permanently delete this record? This action cannot be undone.</p>
                <div className="flex justify-center space-x-4 mt-4">
                    <button
                        onClick={() => setConfirmingDeleteId(null)}
                        className="py-3 px-5 border border-gray-300 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        Cancel
                    </button>
                    <button
                        onClick={handleDeleteRecord}
                        className="py-3 px-5 bg-red-600 text-white rounded-xl text-sm font-medium hover:bg-red-700 transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    );

    // AdminWrapper component
    const AdminWrapper = () => {
        let adminContent;
        if (currentView === 'dashboard') {
            adminContent = <AdminDashboardMain />;
        } else if (currentView === 'location') {
            adminContent = <OfficeSettings />;
        } else if (currentView === 'monthlyReport') {
            adminContent = <AdminMonthlyReport />;
        } else if (currentView === 'employeeManagement') {
            adminContent = <EmployeeManagement />;
        }

        return (
            <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-4xl space-y-6">
                <h1 className="text-3xl font-bold text-center text-gray-800">Admin Panel</h1>
                <p className="text-center text-gray-600">Hello, Admin ({userName})</p>
                <div className="flex justify-center flex-wrap space-x-2 space-y-2 md:space-y-0 border-b pb-4">
                    <button
                        onClick={() => setCurrentView('dashboard')}
                        className={`py-2 px-4 font-bold rounded-xl flex items-center transition-colors duration-200 ${currentView === 'dashboard' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}>
                        <Calendar className="mr-2" size={20} />
                        Monthly Report
                    </button>
                    <button
                        onClick={() => setCurrentView('employeeManagement')}
                        className={`py-2 px-4 font-bold rounded-xl flex items-center transition-colors duration-200 ${currentView === 'employeeManagement' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}>
                        <Users className="mr-2" size={20} />
                        Employees
                    </button>
                    <button
                        onClick={() => setCurrentView('location')}
                        className={`py-2 px-4 font-bold rounded-xl flex items-center transition-colors duration-200 ${currentView === 'location' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}>
                        <MapPin className="mr-2" size={20} />
                        Office Settings
                    </button>
                </div>
                {adminContent}
                {isManualEntryModalOpen && <ManualEntryModal />}
                {confirmingDeleteId && <DeleteConfirmationModal />}
            </div>
        );
    };
    
    // Main App rendering logic
    let content;
    if (!userId) {
        content = <LoginPage />;
    } else if (isAdmin) {
        content = <AdminWrapper />;
    } else if (currentView === 'attendanceHistory') {
        content = <AttendanceHistoryPage />;
    } else {
        content = <EmployeeDashboard />;
    }

    return (
        <div className="bg-gray-100 min-h-screen font-sans flex items-center justify-center p-4">
            <style>
                {`
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
                body { font-family: 'Inter', sans-serif; }
                `}
            </style>
            {content}
        </div>
    );
}
